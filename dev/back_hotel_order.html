<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous" />
  @@include('layout/back_style.html')
  <title>樂寵後台管理</title>
</head>

<body class="backend">
  <nav class="navbar navbar-light" style="background-color: #ffc857">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <a href="index.html"><img class="ms-5" src="img/common/i_logo.png" alt="" style="max-width: 50px" /></a>
        <p class="navbar-brand ms-3">樂寵後台管理</p>
      </div>
      <div class="me-5">
        <a href="#">登出</a>
      </div>
    </div>
  </nav>
  <div class="container mt-5">
    <div class="row">
      @@include('back_leftSide.html')
      <div class="col-10">
        <h2 class="mb-3">旅館訂單管理</h2>
        <select id="byNumber">
          <option value="訂單編號">訂單編號</option>
          <option value="會員編號">會員名稱</option>
        </select>
        <input type="text" id="name" class="mb-3 ms-2" />
        <table class="table table-striped table-hover text-center">
          <thead>
            <tr class="table-warning">
              <th>訂單編號</th>
              <th>名字</th>
              <th>成立日期</th>
              <th>入住起日</th>
              <th>入住迄日</th>
              <th>房型</th>
              <th>人數</th>
              <th>寵物數</th>
              <th>訂單狀態</th>
              <th>編輯</th>
            </tr>
          </thead>
          <tbody class="data">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  <script src="./js/orderNumber.js"></script>
  <script>
    axios.post("php/back_end_API/H_select_order.php").then((res) => {
      getData(res);
      $('.H_orderNumber').text(res.data.length)
    });
    function getData(res) {
      for (let i = 0; i < res.data.length; i++) {
        // 日期轉為10位數
        res.data[i].CREATE_DATE = res.data[i].CREATE_DATE.slice(0,10)

        let data = `
          <tr class="show">
              <td style="display: none"><input value="${res.data[i].HOTEL_ORDER_ID}" name="HOTEL_ORDER_ID" disabled readonly></td>
              <td class="HOTEL_ORDER_ID">${res.data[i].HOTEL_ORDER_ID}</td>
              <td class="FK_MEMBER_ID" style="width:80px">${res.data[i].NAME}</td>
              <td>${res.data[i].CREATE_DATE}</td>
              <td>
                <input type="text" name="BOOKING_CHECKIN_DATE" style="width:100px" value="${res.data[i].BOOKING_CHECKIN_DATE}" disabled/>
              </td>
              <td>
                <input type="text" name="BOOKING_CHECKOUT_DATE" style="width:100px" value="${res.data[i].BOOKING_CHECKOUT_DATE}" disabled/>
              </td>
              <td>${res.data[i].ROOM_NAME}</td>
              <td>
                <input type="text" style="width:30px" name="NUM_OF_PEOPLE" value="${res.data[i].NUM_OF_PEOPLE}" disabled/>
              </td>
              <td>
                <input type="text" style="width:30px" name="NUM_OF_PETS" value="${res.data[i].NUM_OF_PETS}" disabled />
              </td>
              <td>
                <select name="ORDER_STATUS" disabled>
                  <option class="noShow" value="${res.data[i].ORDER_STATUS}" selected>${res.data[i].ORDER_STATUS === "1"? "已完成" : "未完成" }</option>
                  <option value="0">未完成</option>
                  <option value="1">已完成</option>
                </select>
              </td>
              <td class="edit">
                <button class="btn btn-warning btn-sm">編輯</button>
              </td>
              <td style="display: none" class="save">
                <button class="btn btn-warning btn-sm">儲存</button>
              </td>
          </tr>
        `;
        $(".data").append(data);
      }
    }

    //編輯
    $(".data").on("click", ".edit", function (e) {
      e.preventDefault();
      // 使其無法同時編輯兩個
      $('.data').find('input, select').attr('disabled', true)
      $('.edit').css('display', 'table-cell')
      $('.save').css('display', 'none')


      $(this).parent().find("input, select").attr("disabled", false);
      $(this).css("display", "none");
      $(this).next().css("display", "table-cell");
      $('.noShow').hide()
    });

    //儲存
    $(".data").on("click", ".save", function () {
      $(this).parent().parent().find("input, select").attr("disabled", true);
      $(this).css("display", "none");
      $(this).prev().css("display", "table-cell");

      let HOTEL_ORDER_ID = $(this).parent().find("input[name='HOTEL_ORDER_ID']").val();
      let BOOKING_CHECKIN_DATE = $(this).parent().find("input[name='BOOKING_CHECKIN_DATE']").val();
      let BOOKING_CHECKOUT_DATE = $(this).parent().find("input[name='BOOKING_CHECKOUT_DATE']").val();
      let NUM_OF_PEOPLE = $(this).parent().find("input[name='NUM_OF_PEOPLE']").val();
      let NUM_OF_PETS = $(this).parent().find("input[name='NUM_OF_PETS']").val();
      let ORDER_STATUS = $(this).parent().find("select[name='ORDER_STATUS']").val();


      $.ajax({
        method: "POST",
        url: "php/back_end_API/H_Update_order.php",
        data:{
          'HOTEL_ORDER_ID': HOTEL_ORDER_ID,
          'BOOKING_CHECKIN_DATE': BOOKING_CHECKIN_DATE,
          'BOOKING_CHECKOUT_DATE': BOOKING_CHECKOUT_DATE,
          'NUM_OF_PEOPLE': NUM_OF_PEOPLE,
          'NUM_OF_PETS': NUM_OF_PETS,
          'ORDER_STATUS': ORDER_STATUS
        },
        dataType: "text",
        success: function (res) {
          alert("修改成功")
        },
        error: function(exception) {
          alert("修改失敗")
        }
      });
    });


    // 搜尋bar
    $("#name").on("keyup", function() {
      let byOrderNum = $('#byNumber').val()
      var value = $(this).val();
        if(byOrderNum === "訂單編號"){
          $(".HOTEL_ORDER_ID").filter(function() {
              $(this).parent().toggle($(this).text().indexOf(value) != -1)			
          });
        }else{
          $(".FK_MEMBER_ID").filter(function() {
              $(this).parent().toggle($(this).text().indexOf(value) != -1)			
          });
        }
    });

  </script>
</body>

</html>
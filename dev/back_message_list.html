<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  @@include('layout/back_style.html')
  <title>樂寵後台管理</title>
</head>

<body class="backend">
  <nav class="navbar navbar-light" style="background-color: #FFC857;">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <a href="index.html"><img class="ms-5" src="img/common/i_logo.png" alt="" style="max-width: 50px" /></a>
        <p class="navbar-brand ms-3">樂寵後台管理</p>
      </div>
      <div class="me-5"><a href="#" onclick="logout()">登出</a></div>
    </div>
  </nav>
  <div class="container mt-5">
    <div class="row">
      @@include('back_leftSide.html')
      <div class="col-10">
        <h2 class="mb-3">商城留言管理</h2>
        <label for="name">訂單編號</label>
        <input type="text" id="name" class="mb-3 ms-2">
        <table class="table table-striped table-hover text-center">
          <thead>
            <tr class="table-warning">
              <th>留言編號</th>
              <th>訂單編號</th>
              <th>訂單回饋</th>
              <th>官方回覆</th>
              <th>編輯</th>
            </tr>
          </thead>
          <tbody class="data">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  <script src="./js/orderNumber.js"></script>
  <script>
    axios.post("php/back_end_API/SM_select.php").then((res) => {
      getData(res)
    })
    function getData(res) {
      for (let i = 0; i < res.data.length; i++) {

        let data = `
          <tr class="dataTable">
                <td style="display: none"><input value="${res.data[i].MESSAGE_LIST_ID}" name="MESSAGE_LIST_ID" disabled readonly></td>
                <td class="MESSAGE_LIST_ID">${res.data[i].MESSAGE_LIST_ID}</td>
                <td>${res.data[i].FK_SHOPPING_ORDER_ID}</td>
                <td>${res.data[i].MESSAGE_CONTENT}</td>
                <td>
                  <textarea name="OFFICAL_FEEDBACK" cols="35" rows="3" disabled>${res.data[i].OFFICAL_FEEDBACK}</textarea>
                </td>
                <td class="edit"><button class="btn btn-warning btn-sm">編輯</button></td>
                <td style="display: none" class="save"><button class="btn btn-warning btn-sm">儲存</button></td>
          </tr>
          `
        $('.data').append(data)
      }
    }

  


      //編輯
      $('.data').on('click', '.edit', function(e){
        e.preventDefault()
        // 使其無法同時編輯兩個
        $('.data').find('textarea').attr('disabled', true)
        $('.edit').css('display', 'table-cell')
        $('.save').css('display', 'none')


        $(this).parent().find('textarea').attr('disabled', false)
        $(this).css('display', 'none')
        $(this).next().css('display', 'table-cell')
        $('.noShow').hide()
      });

      //儲存
      $('.data').on('click', '.save', function(){
        $(this).parent().parent().find('textarea').attr('disabled', true)
        $(this).css('display', 'none')
        $(this).prev().css('display', 'table-cell')

        let MESSAGE_LIST_ID = $(this).parent().find("input[name='MESSAGE_LIST_ID']").val()
        let OFFICAL_FEEDBACK = $(this).parent().find("textarea[name='OFFICAL_FEEDBACK']").val()


        $.ajax({            
            method: "POST",
            url: "php/back_end_API/SM_update.php",
            data:{
              'MESSAGE_LIST_ID': MESSAGE_LIST_ID,
              'OFFICAL_FEEDBACK': OFFICAL_FEEDBACK,
            },            
            dataType: "text",
            success: function (res) {
              console.log(res);
            },
            error: function(exception) {
              alert("修改失敗");     
            }
        });
      });

      // 搜尋bar
      $("#name").on("keyup", function() {
        var value = $(this).val();
						$(".MESSAGE_LIST_ID").filter(function() {
								$(this).parent().toggle($(this).text().indexOf(value) != -1)			
						});
			});

      function logout() {
        let m_leave = '確認登出嗎?';
        if (confirm(m_leave) == true) {
          localStorage.clear(); //清除local

          $.ajax({
            //清除session ID
            method: 'POST',
            url: './php/front_end_API/M_removesession_MID.php',
            data: {},
            dataType: 'text',
            success: function success(response) {
              window.location.href = "index.html";
            },
            error: function error(exception) {
              alert('數據載入失敗: ' + exception.status);
            },
          });
        }
      }
  </script>
</body>

</html>
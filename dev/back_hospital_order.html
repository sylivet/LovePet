<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous" />
  <!-- css -->
<link rel="icon" type="image/x-icon" href="img/common/favicon.ico"/>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap">
<link rel="stylesheet" href="css/style.css">

<!-- js -->
<script src="//s3-ap-northeast-1.amazonaws.com/justfont-user-script/jf-62461.js"></script>
<script src="js/m_header.js"></script>
  <title>樂寵後台管理</title>
</head>

<body class="backend">
  <nav class="navbar navbar-light" style="background-color: #ffc857">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <img class="ms-5" src="img/common/i_logo.png" alt="" style="max-width: 50px" />
        <p class="navbar-brand ms-3">樂寵後台管理</p>
      </div>
      <div class="me-5">
        <a href="#">登出</a>
      </div>
    </div>
  </nav>
  <div class="container mt-5">
    <div class="row">
      <div class="col-2">
        <div class="list-group text-center">
          <a href="back_member.html" class="
              list-group-item list-group-item-action list-group-item-success
            ">會員管理</a>
          <a href="back_news.html" class="
              list-group-item list-group-item-action list-group-item-success
            ">消息管理</a>
          <a class="
              list-group-item list-group-item-action list-group-item-success
            " data-bs-toggle="collapse" href="#order-list" role="button" aria-expanded="false"
            aria-controls="order-list"><span class="badge bg-success rounded-pill">0</span> 訂單管理</a>
          <div class="collapse" id="order-list">
            <a href="back_restaurant_order.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              "><span class="badge bg-success rounded-pill">0</span> 餐廳訂單</a>
            <a href="back_hotel_order.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              "><span class="badge bg-success rounded-pill">0</span> 旅館訂單</a>
            <a href="back_hospital_order.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              "><span class="badge bg-success rounded-pill C_orderNumber">0</span> 健檢訂單</a>
            <a href="back_shopping_order.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              "><span class="badge bg-success rounded-pill">0</span> 商城訂單</a>
          </div>
          <a class="
              list-group-item list-group-item-action list-group-item-success
            " data-bs-toggle="collapse" href="#product-list" role="button" aria-expanded="false"
            aria-controls="product-list">商品管理</a>
          <div class="collapse" id="product-list">
            <a href="back_restaurant_meal.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              ">餐廳餐點</a>
            <a href="back_room_type.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              ">旅館房型</a>
            <a href="back_health_check.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              ">健檢項目</a>
            <a href="back_shopping_product.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              ">商城商品</a>
          </div>
          <a href="back_message_list.html" class="
              list-group-item list-group-item-action list-group-item-success
            "><span class="badge bg-success rounded-pill">0</span> 商城留言</a>
        </div>
      </div>
      <div class="col-10">
        <h2 class="mb-3">健檢訂單管理</h2>
        <select name="" id="byNumber">
          <option value="">訂單編號</option>
          <option value="">會員編號</option>
        </select>
        <input type="text" id="name" class="mb-3 ms-2" />
        <button type="button" class="btn btn-success btn-sm ms-2 mb-2">
          搜尋
        </button>
        <table class="table table-striped table-hover text-center">
          <thead>
            <tr class="table-warning">
              <th>訂單編號</th>
							<th>會員編號</th>
							<th>成立日期</th>
							<th>預約日期</th>
              <th>健檢套餐</th>
              <th>加價購1</th>
              <th>加價購2</th>
              <th>訂單狀態</th>
              <th>編輯</th>
            </tr>
          </thead>
          <tbody class="data">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
    crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
		<script>
			axios.post("php/back_end_API/C_select_order.php").then((res) => {
				getData(res);
				$('.C_orderNumber').text(res.data.length)
			});

      function getData(res) {
				for (let i = 0; i < res.data.length; i++) {
					// 日期轉為10位數
					res.data[i].BOOKING_DATE = res.data[i].BOOKING_DATE.slice(0,10)
					res.data[i].CREATE_DATE = res.data[i].CREATE_DATE.slice(0,10)

					let data = `
            <tr class="show">
								<td style="display: none"><input value="${res.data[i].HOSPITAL_ORDER_ID}" name="HOSPITAL_ORDER_ID" disabled readonly></td>
								<td class="HOSPITAL_ORDER_ID">${res.data[i].HOSPITAL_ORDER_ID}</td>
								<td class="FK_MEMBER_ID">${res.data[i].FK_MEMBER_ID}</td>
								<td>${res.data[i].CREATE_DATE}</td>
								<td>
									<input type="text" name="BOOKING_DATE" value="${res.data[i].BOOKING_DATE}" disabled/>
								</td>
								<td>
									<input type="text" name="FK_SET_MENU_ID" value="${res.data[i].FK_SET_MENU_ID}" disabled/>
								</td>
								<td>
									<input type="text" name="FK_HEALTH_CHECK_ID" value="${res.data[i].FK_HEALTH_CHECK_ID}" disabled />
								</td>
                <td>
									<input type="text" name="FK_HEALTH_CHECK_ID2" value="${res.data[i].FK_HEALTH_CHECK_ID2}" disabled />
								</td>
								<td>
									<select name="ORDER_STATUS" disabled>
										<option class="noShow" value="${res.data[i].ORDER_STATUS}" selected>${res.data[i].ORDER_STATUS === "1"? "已完成" : "未完成" }</option>
										<option value="0">未完成</option>
										<option value="1">已完成</option>
									</select>
								</td>
								<td class="edit">
									<button class="btn btn-warning btn-sm">編輯</button>
								</td>
								<td style="display: none" class="save">
									<button class="btn btn-warning btn-sm">儲存</button>
								</td>
						</tr>
          `;
					$(".data").append(data);
				}
			}

			//編輯
			$(".data").on("click", ".edit", function (e) {
				e.preventDefault();
				// 使其無法同時編輯兩個
				$('.data').find('input, select').attr('disabled', true)
        $('.edit').css('display', 'block')
        $('.save').css('display', 'none')


				$(this).parent().find("input, select").attr("disabled", false);
				$(this).css("display", "none");
				$(this).next().css("display", "block");
				$('.noShow').hide()
			});

			//儲存
			$(".data").on("click", ".save", function () {
				$(this).parent().parent().find("input, select").attr("disabled", true);
				$(this).css("display", "none");
				$(this).prev().css("display", "block");

				let HOSPITAL_ORDER_ID = $(this).parent().find("input[name='HOSPITAL_ORDER_ID']").val();
				let BOOKING_DATE = $(this).parent().find("input[name='BOOKING_DATE']").val();
				let FK_SET_MENU_ID = $(this).parent().find("input[name='FK_SET_MENU_ID']").val();
				let FK_HEALTH_CHECK_ID = $(this).parent().find("input[name='FK_HEALTH_CHECK_ID']").val();
				let FK_HEALTH_CHECK_ID2 = $(this).parent().find("input[name='FK_HEALTH_CHECK_ID2']").val();
				let ORDER_STATUS = $(this).parent().find("select[name='ORDER_STATUS']").val();


				$.ajax({
					method: "POST",
					url: "php/back_end_API/C_Update_order.php",
					data:{
						'BOOKING_DATE': BOOKING_DATE,
						'FK_SET_MENU_ID': FK_SET_MENU_ID,
						'FK_HEALTH_CHECK_ID': FK_HEALTH_CHECK_ID,
						'FK_HEALTH_CHECK_ID2': FK_HEALTH_CHECK_ID2,
						'ORDER_STATUS': ORDER_STATUS,
						'HOSPITAL_ORDER_ID': HOSPITAL_ORDER_ID
					},
					dataType: "text",
					success: function (res) {
						alert("修改成功")
					},
					error: function(exception) {
						alert("修改失敗")
					}
				});
			});


			// 搜尋bar
			$("#name").on("keyup", function() {
				let byOrderNum = $('#byNumber').val()
				var value = $(this).val();
					if(byOrderNum === "訂單編號"){
						$(".HOSPITAL_ORDER_ID").filter(function() {
								$(this).parent().toggle($(this).text().indexOf(value) != -1)			
						});
					}else{
						$(".FK_MEMBER_ID").filter(function() {
								$(this).parent().toggle($(this).text().indexOf(value) != -1)			
						});
					}
			});

</script>

</body>

</html>
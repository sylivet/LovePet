<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  @@include('layout/back_style.html')
  <style>
    body {
      overflow: auto;
    }
    input {
      width: 80px;
    }

    input[name="NICKNAME"] {
      width: 50px;
    }

    .backend .list-group {
      width: 76%;
    }
  </style>
  <title>樂寵後台管理</title>
</head>

<body class="backend">
  <nav class="navbar navbar-light" style="background-color: #FFC857;">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <a href="index.html"><img class="ms-5" src="img/common/i_logo.png" alt="" style="max-width: 50px" /></a>
        <p class="navbar-brand ms-3">樂寵後台管理</p>
      </div>
      <div class="me-5"><a href="#" onclick="logout()">登出</a></div>
    </div>
  </nav>
  <div>

    <div class="container mt-5">
      <div class="row">
        @@include('back_leftSide.html')
        <div class="col-10">
          <h2 class="mb-3">會員管理</h2>
          <select name="" id="byNumber">
            <option value="會員姓名">會員姓名</option>
          </select>
          <input type="text" id="name" class="mb-3 ms-2">
          <table class="table table-striped table-hover text-center">
            <thead>
              <tr class="table-warning">
                <th>編號</th>
                <th>帳號</th>
                <th>姓名</th>
                <th>地址</th>
                <th>電話</th>
                <th>權限</th>
                <th>訂閱</th>
                <th>貨到通知</th>
                <th>編輯</th>
                <th>刪除</th>
              </tr>
            </thead>
            <tbody class="data">
            </tbody>
          </table>

        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="./js/orderNumber.js"></script>
    <script>
      axios.post("php/back_end_API/M_select.php").then((res) => {
        getData(res)
      })
      function getData(res) {
        for (let i = 0; i < res.data.length; i++) {

          let data = `
              <tr class="dataTable">
                    <td style="display: none"><input value="${res.data[i].MEMBER_ID}" class="MEMBER_ID" name="MEMBER_ID" disabled readonly></td>
                    <td>${res.data[i].MEMBER_ID}</td>
                    <td>${res.data[i].ACCOUNT}</td>
                    <td class="memberName">${res.data[i].NAME}</td>
                    <td><textarea name="ADDRES" cols="10" rows="4" disabled>${res.data[i].ADDRES}</textarea></td>
                    <td><input type="text" name="PHONE" value="${res.data[i].PHONE}" disabled></td>
                    <td >
                      <select name="AUTHORITY" disabled>
                        <option class="noShow" value="${res.data[i].AUTHORITY}" selected>${res.data[i].AUTHORITY}</option>
                        <option value="0">停權</option>
                        <option value="1">管理員</option>
                        <option value="2">會員</option>
                      </select>
                    </td>
                    <td>
                      <select name="SUBSCRIPTION" disabled>
                        <option class="noShow" value="${res.data[i].SUBSCRIPTION}" selected>${res.data[i].SUBSCRIPTION === '0' ? 'N' : 'Y'}</option>
                        <option value="0">N</option>
                        <option value="1">Y</option>
                      </select>
                    </td>
                  
                    <td >
                      <select name="DELIEVERY_NOTICE" disabled>
                        <option class="noShow" value="${res.data[i].DELIEVERY_NOTICE}" selected>${res.data[i].DELIEVERY_NOTICE === '0' ? '簡訊' : '手機'}</option>
                        <option value="0">簡訊</option>
                        <option value="1">手機</option>
                      </select>
                    <td class="edit"><button class="btn btn-warning btn-sm">編輯</button></td>
                    <td style="display: none" class="save"><button class="btn btn-warning btn-sm">儲存</button></td>
                    <td class="cancel"><button class="btn btn-danger btn-sm">刪除</button></td>
              </tr>
              `
          $('.data').append(data)
        }
      }


      //編輯
      $('.data').on('click', '.edit', function (e) {
        e.preventDefault()
        // 使其無法同時編輯兩個
        $('.data').find('input, select').attr('disabled', true)
        $('.edit').css('display', 'table-cell')
        $('.save').css('display', 'none')


        $(this).parent().find('input, select').attr('disabled', false)
        $(this).css('display', 'none')
        $(this).next().css('display', 'table-cell')
        $('.noShow').hide()
      });

      //儲存
      $('.data').on('click', '.save', function () {
        $(this).parent().parent().find('input, select').attr('disabled', true)
        $(this).css('display', 'none')
        $(this).prev().css('display', 'table-cell')

        let MEMBER_ID = $(this).parent().find("input[name='MEMBER_ID']").val()
        let PHONE = $(this).parent().find("input[name='PHONE']").val()
        let DELIEVERY_NOTICE = $(this).parent().find("select[name='DELIEVERY_NOTICE']").val()
        let AUTHORITY = $(this).parent().find("select[name='AUTHORITY']").val()
        let SUBSCRIPTION = $(this).parent().find("select[name='SUBSCRIPTION']").val()


        $.ajax({
          method: "POST",
          url: "php/back_end_API/M_Update.php",
          data: {
            'MEMBER_ID': MEMBER_ID,
            'PHONE': PHONE,
            'DELIEVERY_NOTICE': DELIEVERY_NOTICE,
            'AUTHORITY': AUTHORITY,
            'SUBSCRIPTION': SUBSCRIPTION,
          },
          dataType: "text",
          success: function (res) {
          },
          error: function (exception) {
            alert("修改失敗");
          }
        });
      });

      //刪除
      $('.data').on('click', '.cancel', function () {
        let MEMBER_ID = $(this).parent().find("input[name='MEMBER_ID']").val()

        let yes = confirm("不要亂刪喔!");
        if (yes) {
          $(this).parent().fadeOut()
          $.ajax({
            method: "POST",
            url: "php/back_end_API/M_Delete.php",
            data: {
              'MEMBER_ID': MEMBER_ID,
            },
            dataType: "text",
            success: function (res) {
            }
          });
        }
      });

      // 搜尋bar
      $("#name").on("keyup", function () {
        let byOrderNum = $('#byNumber').val()
        var value = $(this).val();
        $(".memberName").filter(function () {
          $(this).parent().toggle($(this).text().indexOf(value) != -1)
        });
      });

      function logout() {
        let m_leave = '確認登出嗎?';
        if (confirm(m_leave) == true) {
          localStorage.clear(); //清除local

          $.ajax({
            //清除session ID
            method: 'POST',
            url: './php/front_end_API/M_removesession_MID.php',
            data: {},
            dataType: 'text',
            success: function success(response) {
              window.location.href = "index.html";
            },
            error: function error(exception) {
              alert('數據載入失敗: ' + exception.status);
            },
          });
        }
      }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    @@include('layout/style.html')
    <title>樂寵後台管理</title>
</head>

<body class="backend">
    <nav class="navbar navbar-light" style="background-color: #FFC857;">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <img class="ms-5" src="img/common/i_logo.png" alt="" style="max-width: 50px;">
                <p class="navbar-brand ms-3">樂寵後台管理</p>
            </div>
            <div class="me-5"><a href="#">登出</a></div>
        </div>
    </nav>
    <div>

    <div class="container mt-5">
    <div class="row">
        <div class="col-2">
            <div class="list-group text-center">
                <a href="back_member.html" class="
                  list-group-item list-group-item-action list-group-item-success
                ">會員管理</a>
                <a href="back_news.html" class="
                  list-group-item list-group-item-action list-group-item-success
                ">消息管理</a>
                <a class="
                  list-group-item list-group-item-action list-group-item-success
                " data-bs-toggle="collapse" href="#order-list" role="button" aria-expanded="false"
                    aria-controls="order-list"><span class="badge bg-success rounded-pill">0</span> 訂單管理</a>
                <div class="collapse" id="order-list">
                    <a href="back_restaurant_order.html" class="
                    list-group-item
                    list-group-item-action
                    list-group-item-secondary
                  "><span class="badge bg-success rounded-pill">0</span> 餐廳訂單</a>
                    <a href="back_hotel_order.html" class="
                    list-group-item
                    list-group-item-action
                    list-group-item-secondary
                  "><span class="badge bg-success rounded-pill">0</span> 旅館訂單</a>
                    <a href="back_hospital_order.html" class="
                    list-group-item
                    list-group-item-action
                    list-group-item-secondary
                  "><span class="badge bg-success rounded-pill">0</span> 健檢訂單</a>
                    <a href="back_shopping_order.html" class="
                    list-group-item
                    list-group-item-action
                    list-group-item-secondary
                  "><span class="badge bg-success rounded-pill">0</span> 商城訂單</a>
                </div>
                <a class="
                  list-group-item list-group-item-action list-group-item-success
                " data-bs-toggle="collapse" href="#product-list" role="button" aria-expanded="false"
                    aria-controls="product-list">商品管理</a>
                <div class="collapse" id="product-list">
                    <a href="back_restaurant_meal.html" class="
                    list-group-item
                    list-group-item-action
                    list-group-item-secondary
                  ">餐廳餐點</a>
                    <a href="back_room_type.html" class="
                    list-group-item
                    list-group-item-action
                    list-group-item-secondary
                  ">旅館房型</a>
                    <a href="back_health_check.html" class="
                    list-group-item
                    list-group-item-action
                    list-group-item-secondary
                  ">健檢項目</a>
                    <a href="back_shopping_product.html" class="
                    list-group-item
                    list-group-item-action
                    list-group-item-secondary
                  ">商城商品</a>
                </div>
                <a href="back_message_list.html" class="
                  list-group-item list-group-item-action list-group-item-success
                "><span class="badge bg-success rounded-pill">0</span> 商城留言</a>
            </div>
        </div>
        <div class="col-10">
            <h2 class="mb-3">會員管理</h2>
                <select name="" id="">
                    <option value="">會員編號</option>
                    <option value="">會員姓名</option>
                </select>
                <input type="text" id="name" class="mb-3 ms-2">
                <button type="button" class="btn btn-success btn-sm ms-2 mb-2">搜尋</button>
                <table class="table table-striped table-hover text-center">
                    <thead>
                        <tr class="table-warning">
                            <th>會員編號</th>
                            <th>會員帳號</th>
                            <th>會員稱呼</th>
                            <th>會員全名</th>
                            <th>會員地址</th>
                            <th>連絡電話</th>
                            <th>會員權限</th>
                            <th>是否訂閱</th>
                            <th>貨到通知</th>
                            <th>會員照片</th>
                            <th>編輯</th>
                            <th>刪除</th>
                        </tr>
                    </thead>
                    <tbody class="data">
                    </tbody>
                </table>
        </div>
    </div>
    </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
        <script>
          axios.post("php/back_end_API/M_select.php").then((res)=>{
            getData(res)
          })
          function getData(res){
            for(let i = 0; i< res.data.length; i++){
    
              let data = `
              <tr class="dataTable">
                    <td style="display: none"><input value="${res.data[i].MEMBER_ID}" name="MEMBER_ID" disabled readonly></td>
                    <td>${res.data[i].MEMBER_ID}</td>
                    <td><input type="text" name="ACCOUNT" value="${res.data[i].ACCOUNT}" disabled></td>
                    <td><input type="text" name="NICKNAME" value="${res.data[i].NICKNAME}" disabled></td>
                    <td><input type="text" name="NAME" value="${res.data[i].NAME}" disabled></td>
                    <td><input type="text" name="ADDRES" value="${res.data[i].ADDRES}" disabled></td>
                    <td><input type="text" name="PHONE" value="${res.data[i].PHONE}" disabled></td>
                    <td><input type="text" name="AUTHORITY" value="${res.data[i].AUTHORITY}" disabled></td>
                    <td>
                      <select name="SUBSCRIPTION" disabled>
                        <option class="noShow" value="${res.data[i].SUBSCRIPTION}" selected>${res.data[i].SUBSCRIPTION}</option>
                        <option value="2">2</option>
                        <option value="1">1</option>
                      </select>
                    </td>
                  
                    <td>
                      <select name="DELIEVERY_NOTICE" disabled>
                        <option class="noShow" value="${res.data[i].DELIEVERY_NOTICE}" selected>${res.data[i].DELIEVERY_NOTICE}</option>
                        <option value="2">2</option>
                        <option value="1">1</option>
                        <option value="0">0</option>
                      </select>
                    <td style="display: none"><input type="text" name="MEMBER_IMG" value="${res.data[i].MEMBER_IMG}" disabled></td>
                    <td><img src="${res.data[i].MEMBER_IMG}" style="width:30px;"></td>

                    <td class="edit"><button class="btn btn-warning btn-sm">編輯</button></td>
                    <td style="display: none" class="save"><button class="btn btn-warning btn-sm">儲存</button></td>
                    <td class="cancel"><button class="btn btn-danger btn-sm">刪除</button></td>
              </tr>
              `
              $('.data').append(data)
            }
          }
    
          let isChangeOnShelf;
          
          //編輯
          $('.data').on('click', '.edit', function(e){
            e.preventDefault()
            // 使其無法同時編輯兩個
            $('.data').find('input, select').attr('disabled', true)
            $('.edit').css('display', 'block')
            $('.save').css('display', 'none')
    
    
            $(this).parent().find('input, select').attr('disabled', false)
            $(this).css('display', 'none')
            $(this).next().css('display', 'block')
            $('.noShow').hide()
            isChangeOnShelf = $(this).parent().find("select[name='MEAL_STATUS']").val()
          });
    
          //儲存
          $('.data').on('click', '.save', function(){
            $(this).parent().parent().find('input, select').attr('disabled', true)
            $(this).css('display', 'none')
            $(this).prev().css('display', 'block')
    
            let MEMBER_ID = $(this).parent().find("input[name='MEMBER_ID']").val()
            let DELIEVERY_NOTICE = $(this).parent().find("select[name='DELIEVERY_NOTICE']").val()
            let ACCOUNT = $(this).parent().find("input[name='ACCOUNT']").val()
            let NAME = $(this).parent().find("input[name='NAME']").val()
            let MEMBER_IMG = $(this).parent().find("input[name='MEMBER_IMG']").val()
            let MEAL_STATUS = $(this).parent().find("select[name='MEAL_STATUS']").val() //跟會員功能有關，先不動
            let SUBSCRIPTION = $(this).parent().find("select[name='SUBSCRIPTION']").val()
            let ADDRES = $(this).parent().find("input[name='ADDRES']").val()
            let NICKNAME = $(this).parent().find("input[name='NICKNAME']").val()
            let PHONE = $(this).parent().find("input[name='PHONE']").val()
            let eng = $(this).parent().find("input[name='eng']").val()
    
            
            $.ajax({            
                method: "POST",
                url: "php/back_end_API/R_Update.php",
                data:{
                  'ACCOUNT': ACCOUNT,
                  'DELIEVERY_NOTICE': DELIEVERY_NOTICE,
                  'MEMBER_ID': MEMBER_ID,
                  //'NAME': NAME,
                  'MEMBER_IMG': MEMBER_IMG,
                  //'MEAL_STATUS': MEAL_STATUS,
                  'SUBSCRIPTION': SUBSCRIPTION,
                  'ADDRES': ADDRES,
                  'NICKNAME': NICKNAME,
                  'PHONE': PHONE,
                  //'eng': eng,
                },            
                dataType: "text",
                success: function (res) {   
                  if(isChangeOnShelf!=MEAL_STATUS){
    
                    $(this).closest('.dataTable').fadeOut()
    
                    setTimeout(()=>{
                      // 清空重新撈資料
                      $('.data').html('')
                      $('#onshelf').val('2')
                      axios.post("php/back_end_API/R_select.php").then((res)=>{
                          getData(res)
                      })
    
                      alert("修改成功");
                    },500)
                  }else{
                    alert("修改成功");
                  }
                },
                error: function(exception) {
                  alert("修改失敗");     
                }
            });
    
            //判斷是否改變上下架
            if(isChangeOnShelf!=MEAL_STATUS){
              $(this).closest('.dataTable').fadeOut()
            }
          });
    
          //刪除
          $('.data').on('click', '.cancel', function(){
            let MEMBER_ID = $(this).parent().find("input[name='MEMBER_ID']").val()
    
            let yes = confirm("不要亂刪喔!");
            if(yes){
              $(this).parent().fadeOut()
              $.ajax({            
                method: "POST",
                url: "php/back_end_API/R_Delete.php",
                data:{
                  'MEMBER_ID': MEMBER_ID,
                },            
                dataType: "text",
                success: function (res) {     
                  alert("已刪除");
                },
                error: function(exception) {
                  alert("修改失敗");     
                }
              });
            }
          });
    
          // 搜尋bar
          $("#onshelf").on("change", function() {
            var value = $(this).val();
              if(value == 0){
                $(".noShow").filter(function() {
                    $(this).closest('.dataTable').toggle($(this).val().indexOf(value) != -1);			
                });
              }else if(value == 1){
                $(".noShow").filter(function() {
                    $(this).closest('.dataTable').toggle($(this).val().indexOf(value) != -1);			
                });
              }else{
                $(".noShow").filter(function() {
                    $(this).closest('.dataTable').toggle($(this).val().indexOf(value) == -1);			
                });
              }
          });
    
    
    
        </script>
</body>
</html>
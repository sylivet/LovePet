<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous" />
  @@include('layout/back_style.html')
  <style>
    body{
      overflow: auto;
    }
    input{
      width: 80px;
    }

  </style>
  <title>樂寵後台管理</title>
</head>
<body class="backend">
  <nav class="navbar navbar-light" style="background-color: #ffc857">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <a href="index.html"><img class="ms-5" src="img/common/i_logo.png" alt="" style="max-width: 50px" /></a>
        <p class="navbar-brand ms-3">樂寵後台管理</p>
      </div>
      <div class="me-5"><a href="#">登出</a></div>
    </div>
  </nav>
  <div class="container mt-5">
    <div class="row">
      <div class="col-2">
        <div class="list-group text-center">
          <a href="back_member.html" class="
              list-group-item list-group-item-action list-group-item-success
            ">會員管理</a>
          <a href="back_news.html" class="
              list-group-item list-group-item-action list-group-item-success
            ">消息管理</a>
          <a class="
              list-group-item list-group-item-action list-group-item-success
            " data-bs-toggle="collapse" href="#order-list" role="button" aria-expanded="false"
            aria-controls="order-list"><span class="badge bg-success rounded-pill">0</span> 訂單管理</a>
          <div class="collapse" id="order-list">
            <a href="back_restaurant_order.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              "><span class="badge bg-success rounded-pill">0</span> 餐廳訂單</a>
            <a href="back_hotel_order.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              "><span class="badge bg-success rounded-pill">0</span> 旅館訂單</a>
            <a href="back_hospital_order.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              "><span class="badge bg-success rounded-pill">0</span> 健檢訂單</a>
            <a href="back_shopping_order.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              "><span class="badge bg-success rounded-pill">0</span> 商城訂單</a>
          </div>
          <a class="
              list-group-item list-group-item-action list-group-item-success
            " data-bs-toggle="collapse" href="#product-list" role="button" aria-expanded="false"
            aria-controls="product-list">商品管理</a>
          <div class="collapse" id="product-list">
            <a href="back_restaurant_meal.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              ">餐廳餐點</a>
            <a href="back_room_type.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              ">旅館房型</a>
            <a href="back_health_check.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              ">健檢項目</a>
            <a href="back_shopping_product.html" class="
                list-group-item
                list-group-item-action
                list-group-item-secondary
              ">商城商品</a>
          </div>
          <a href="back_message_list.html" class="
              list-group-item list-group-item-action list-group-item-success
            "><span class="badge bg-success rounded-pill">0</span> 商城留言</a>
        </div>
      </div>
      <div class="col-10">
        <h2 class="mb-3">餐廳餐點管理</h2>
        <div class="d-flex justify-content-between mb-3">
          <a href="back_restaurant_meal_create.html" class="btn btn-success btn-sm">新增餐點</a>
          <select id="onshelf">
            <option value="2" selected>All</option>
            <option value="1">上架中</option>
            <option value="0">下架中</option>
          </select>
        </div>
          <table class="table table-striped table-hover text-center">
            <thead>
              <tr class="table-warning">
                <th>餐點編號</th>
                <th>名稱</th>
                <th>英文名稱</th>
                <th>類型</th>
                <th>分類</th>
                <th>資訊</th>
                <th>價格</th>
                <th>圖片</th>
                <th>卡路里</th>
                <th>狀態</th>
                <th>編輯</th>
                <th>刪除</th>
              </tr>
            </thead>
              <tbody class="data">
              </tbody>
          </table>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

    <script>
      axios.post("php/back_end_API/R_select.php").then((res)=>{
        getData(res)
      })
      function getData(res){
        for(let i = 0; i< res.data.length; i++){

          let data = `
          <tr class="dataTable">
                <td style="display: none"><input value="${res.data[i].MEAL_DATA_ID}" name="MEAL_DATA_ID" disabled readonly></td>
                <td>${res.data[i].MEAL_DATA_ID}</td>
                <td><input type="text" name="MEAL_NAME" value="${res.data[i].MEAL_NAME}" disabled></td>
                <td><input type="text" name="eng" value="${res.data[i].eng}" disabled></td>
                <td>
                  <select name="MEAL_CATA" disabled>
                    <option class="noShow" value="${res.data[i].MEAL_CATA}" selected>${res.data[i].MEAL_CATA}</option>
                    <option value="petsCustom">客製寵食</option>
                    <option value="petsFood">現有寵食</option>
                    <option value="humanFood">現有人食</option>
                  </select>
                </td>
                <td>
                  <select name="MEAL_TYPE" disabled>
                    <option class="noShow" value="${res.data[i].MEAL_TYPE}" selected>${res.data[i].MEAL_TYPE}</option>
                    <option value="乾糧">乾糧</option>
                    <option value="主食">主食</option>
                    <option value="配菜">配菜</option>
                    <option value="美式">美式</option>
                    <option value="義式">義式</option>
                    <option value="沙拉">沙拉</option>
                    <option value="鮮食">鮮食</option>
                  </select>
                </td>
                <td><input type="text" name="MEAL_MSG" value="${res.data[i].MEAL_MSG}" disabled></td>
                <td><input type="text" name="MEAL_PRICE" value="${res.data[i].MEAL_PRICE}" class="test" disabled></td>
                <td style="display: none"><input type="text" name="MEAL_IMG" value="${res.data[i].MEAL_IMG}" disabled></td>
                <td><img src="${res.data[i].MEAL_IMG}" style="width:80px;"></td>
                <td><input type="text" name="MEAL_CAL" value="${res.data[i].MEAL_CAL}" disabled></td>
                <td>
                  <select name="MEAL_STATUS" disabled>
                    <option class="noShow" value="${res.data[i].MEAL_STATUS}" selected>${res.data[i].MEAL_STATUS === "1"? "上架" : "下架" }</option>
                    <option value="1">上架</option>
                    <option value="0">下架</option>
                  </select>
                </td>
                <td class="edit"><button class="btn btn-warning btn-sm">編輯</button></td>
                <td style="display: none" class="save"><button class="btn btn-warning btn-sm">儲存</button></td>
                <td class="cancel"><button class="btn btn-danger btn-sm">刪除</button></td>
          </tr>
          `
          $('.data').append(data)
        }
      }

      let isChangeOnShelf;
      
      //編輯
      $('.data').on('click', '.edit', function(e){
        e.preventDefault()
        // 使其無法同時編輯兩個
        $('.data').find('input, select').attr('disabled', true)
        $('.edit').css('display', 'table-cell')
        $('.save').css('display', 'none')


        $(this).parent().find('input, select').attr('disabled', false)
        $(this).css('display', 'none')
        $(this).next().css('display', 'table-cell')
        $('.noShow').hide()
        isChangeOnShelf = $(this).parent().find("select[name='MEAL_STATUS']").val()
      });

      //儲存
      $('.data').on('click', '.save', function(){
        $(this).parent().parent().find('input, select').attr('disabled', true)
        $(this).css('display', 'none')
        $(this).prev().css('display', 'table-cell')

        let MEAL_DATA_ID = $(this).parent().find("input[name='MEAL_DATA_ID']").val()
        let MEAL_TYPE = $(this).parent().find("select[name='MEAL_TYPE']").val()
        let MEAL_NAME = $(this).parent().find("input[name='MEAL_NAME']").val()
        let MEAL_PRICE = $(this).parent().find("input[name='MEAL_PRICE']").val()
        let MEAL_IMG = $(this).parent().find("input[name='MEAL_IMG']").val()
        let MEAL_STATUS = $(this).parent().find("select[name='MEAL_STATUS']").val()
        let MEAL_CATA = $(this).parent().find("select[name='MEAL_CATA']").val()
        let MEAL_CAL = $(this).parent().find("input[name='MEAL_CAL']").val()
        let MEAL_MSG = $(this).parent().find("input[name='MEAL_MSG']").val()
        let MEAL_COUNT = $(this).parent().find("input[name='MEAL_COUNT']").val()
        let eng = $(this).parent().find("input[name='eng']").val()

        //判斷是否改變上下架
        if(isChangeOnShelf!=MEAL_STATUS){
          $(this).closest('.dataTable').fadeOut()
        }

        $.ajax({            
            method: "POST",
            url: "php/back_end_API/R_Update.php",
            data:{
              'MEAL_NAME': MEAL_NAME,
              'MEAL_TYPE': MEAL_TYPE,
              'MEAL_DATA_ID': MEAL_DATA_ID,
              'MEAL_PRICE': MEAL_PRICE,
              'MEAL_IMG': MEAL_IMG,
              'MEAL_STATUS': MEAL_STATUS,
              'MEAL_CATA': MEAL_CATA,
              'MEAL_CAL': MEAL_CAL,
              'MEAL_MSG': MEAL_MSG,
              'MEAL_COUNT': MEAL_COUNT,
              'eng': eng,
            },            
            dataType: "text",
            success: function (res) {   
              if(isChangeOnShelf!=MEAL_STATUS){
                setTimeout(()=>{
                  // 清空重新撈資料
                  $('.data').html('')
                  $('#onshelf').val('2')
                  axios.post("php/back_end_API/R_select.php").then((res)=>{
                      getData(res)
                  })

                  alert("修改成功");
                },500)
              }else{
                alert("修改成功");
              }
            },
            error: function(exception) {
              alert("修改失敗");     
            }
        });
      });

      //刪除
      $('.data').on('click', '.cancel', function(){
        let MEAL_DATA_ID = $(this).parent().find("input[name='MEAL_DATA_ID']").val()

        let yes = confirm("不要亂刪喔!");
        if(yes){
          
          $(this).parent().fadeOut()

          $.ajax({            
            method: "POST",
            url: "php/back_end_API/R_Delete.php",
            data:{
              'MEAL_DATA_ID': MEAL_DATA_ID,
            },            
            dataType: "text",
            success: function (res) {
              setTimeout(()=>{
                // 清空重新撈資料
                $('.data').html('')
                $('#onshelf').val('2')
                axios.post("php/back_end_API/R_select.php").then((res)=>{
                    getData(res)
                })
                alert("已刪除");
              },500)
            },
            error: function(exception) {
              alert("修改失敗");     
            }
          });
        }
      });

      // 搜尋bar
			$("#onshelf").on("change", function() {
				var value = $(this).val();
					if(value == 0){
						$(".noShow").filter(function() {
								$(this).closest('.dataTable').toggle($(this).val().indexOf(value) != -1);			
						});
					}else if(value == 1){
            $(".noShow").filter(function() {
								$(this).closest('.dataTable').toggle($(this).val().indexOf(value) != -1);			
						});
					}else{
            $(".noShow").filter(function() {
								$(this).closest('.dataTable').toggle($(this).val().indexOf(value) == -1);			
						});
          }
			});
    </script>
</body>
</html>